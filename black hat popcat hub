local lib = loadstring(game:HttpGet"https://raw.githubusercontent.com/dawid-scripts/UI-Libs/main/Vape.txt")()
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local PlayerName = LocalPlayer.Name

-- 全局变量
local savedPosition = nil
local numberedPositions = {}
local selectedPlayer = nil
local loopTpActive = false
local loopTpConn = nil
local xrayActive = false
local xrayIgnored = {}
local xrayColor = Color3.fromRGB(255, 255, 0)
-- 甩飞功能变量
local flingSelectedPlayer = nil
local flingActive = false
local flingLoopConn = nil
getgenv().OldPos = nil
getgenv().FPDH = Workspace.FallenPartsDestroyHeight

-- 右上角时间显示
local TimeGui = Instance.new("ScreenGui")
TimeGui.Name = "TimeDisplayGui"
TimeGui.Parent = LocalPlayer.PlayerGui

local TimeLabel = Instance.new("TextLabel")
TimeLabel.Name = "TimeLabel"
TimeLabel.Parent = TimeGui
TimeLabel.BackgroundTransparency = 1
TimeLabel.Position = UDim2.new(0.98, -200, 0.02, 0)
TimeLabel.Size = UDim2.new(0, 200, 0, 30)
TimeLabel.Font = Enum.Font.SourceSans
TimeLabel.TextSize = 14
TimeLabel.TextColor3 = Color3.new(1, 1, 1)
TimeLabel.TextXAlignment = Enum.TextXAlignment.Right
TimeLabel.TextYAlignment = Enum.TextYAlignment.Top
TimeLabel.TextStrokeTransparency = 0.5
TimeLabel.TextStrokeColor3 = Color3.new(0, 0, 0)

local function UpdateTime()
    local CurrentTime = os.date("%H:%M:%S")
    local Weekday = os.date("%A")
    local WeekdayCN = {
        ["Monday"] = "星期一",
        ["Tuesday"] = "星期二",
        ["Wednesday"] = "星期三",
        ["Thursday"] = "星期四",
        ["Friday"] = "星期五",
        ["Saturday"] = "星期六",
        ["Sunday"] = "星期日"
    }
    TimeLabel.Text = string.format("%s  %s", CurrentTime, WeekdayCN[Weekday] or Weekday)
end

UpdateTime()
RunService.Heartbeat:Connect(function()
    UpdateTime()
end)

-- 主面板创建
local win = lib:Window("BHP hub  你好 " .. PlayerName, Color3.fromRGB(44, 120, 224), Enum.KeyCode.RightControl)
local mainTab = win:Tab("通用")
local flyTab = win:Tab("飞行（fly）")
local espTab = win:Tab("透视（esp）")
local tpTab = win:Tab("传送（TP）")
local flingTab = win:Tab("甩飞（fling）") -- 新增甩飞专区
local changeclr = win:Tab("设置（set）")

-- 核心功能
local speed = 16
mainTab:Textbox("移动速度", tostring(speed), function(t)
    speed = tonumber(t) or 16
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.WalkSpeed = speed
    end
end)

local jumpPower = 50
mainTab:Textbox("跳跃高度", tostring(jumpPower), function(t)
    jumpPower = tonumber(t) or 50
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.JumpPower = jumpPower
    end
end)

local infJump = false
mainTab:Toggle("无限跳", infJump, function(t)
    infJump = t
    local UIS = game:GetService("UserInputService")
    local player = LocalPlayer
    
    UIS.InputBegan:Connect(function(input)
        if infJump and input.KeyCode == Enum.KeyCode.Space then
            local humanoid = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end
    end)
end)

local noclip = false
mainTab:Toggle("穿墙", noclip, function(t)
    noclip = t
    local player = LocalPlayer
    local function noclipLoop()
        while noclip and task.wait() do
            local character = player.Character
            if character then
                for _,v in pairs(character:GetDescendants()) do
                    if v:IsA("BasePart") and v.CanCollide then
                        v.CanCollide = false
                    end
                end
            end
        end
    end
    task.spawn(noclipLoop)
end)

local rotateActive = false
local rotateSpeed = 1
local rotateConn = nil
mainTab:Textbox("旋转速度", tostring(rotateSpeed), function(t)
    local num = tonumber(t)
    if num then
        rotateSpeed = math.abs(num)
    end
end)
mainTab:Toggle("启用旋转", rotateActive, function(t)
    rotateActive = t
    if rotateConn then
        rotateConn:Disconnect()
        rotateConn = nil
    end
    if rotateActive then
        rotateConn = RunService.RenderStepped:Connect(function(dt)
            local character = LocalPlayer.Character
            local humanoidRootPart = character and character:FindFirstChild("HumanoidRootPart")
            if humanoidRootPart then
                humanoidRootPart.CFrame = humanoidRootPart.CFrame * CFrame.Angles(0, rotateSpeed * dt, 0)
            end
        end)
    end
end)

local brightnessActive = false
local originalBrightness = Lighting.Brightness
mainTab:Toggle("亮度", brightnessActive, function(t)
    brightnessActive = t
    task.spawn(function()
        while brightnessActive and task.wait() do
            Lighting.Brightness = 3
        end
        Lighting.Brightness = originalBrightness
    end)
end)

local fogRemovalActive = false
local originalFogEnd = Lighting.FogEnd
local originalFogStart = Lighting.FogStart
mainTab:Toggle("除雾", fogRemovalActive, function(t)
    fogRemovalActive = t
    task.spawn(function()
        while fogRemovalActive and task.wait() do
            Lighting.FogEnd = 100000
            Lighting.FogStart = 100000
        end
        Lighting.FogEnd = originalFogEnd
        Lighting.FogStart = originalFogStart
    end)
end)

local customNameActive = false
local customNameText = "自定义名称"
local customNameGui = nil
mainTab:Textbox("自定义头顶名称", customNameText, function(t)
    if t and t ~= "" then
        customNameText = t
        if customNameGui and customNameGui:FindFirstChild("NameLabel") then
            customNameGui.NameLabel.Text = customNameText
        end
    end
end)
mainTab:Toggle("启用自定义头顶显名", customNameActive, function(t)
    customNameActive = t
    if customNameGui then
        customNameGui:Destroy()
        customNameGui = nil
    end
    if customNameActive then
        local character = LocalPlayer.Character
        local head = character and character:FindFirstChild("Head")
        if head then
            customNameGui = Instance.new("BillboardGui")
            customNameGui.Name = "CustomNameTag"
            customNameGui.Parent = head
            customNameGui.Size = UDim2.new(0, 300, 0, 60)
            customNameGui.AlwaysOnTop = true
            customNameGui.ExtentsOffset = Vector3.new(0, 2, 0)
            customNameGui.StudsOffset = Vector3.new(0, 0.5, 0)

            local nameLabel = Instance.new("TextLabel")
            nameLabel.Name = "NameLabel"
            nameLabel.Parent = customNameGui
            nameLabel.BackgroundTransparency = 1
            nameLabel.Size = UDim2.new(1, 0, 1, 0)
            nameLabel.Font = Enum.Font.SourceSansBold
            nameLabel.TextSize = 22
            nameLabel.TextColor3 = Color3.new(1,1,1)
            nameLabel.TextStrokeTransparency = 0.3
            nameLabel.TextStrokeColor3 = Color3.new(0,0,0)
            nameLabel.Text = customNameText
            nameLabel.TextWrapped = true
            nameLabel.TextXAlignment = Enum.TextXAlignment.Center
        end
    end
end)

mainTab:Button("重置人物", function()
    if LocalPlayer.Character then
        LocalPlayer.Character:BreakJoints()
        local humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.Health = 0
        end
    end
end)

-- 飞行专区
flyTab:Button("启用通用飞行", function()
    loadstring(game:HttpGet("https://rawscripts.net/raw/Universal-Script-Fly-gui-v3-78856"))()
end)

flyTab:Button("启用无敌少侠飞行（仅R15有动画）", function()
    local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled
    if isMobile then
        loadstring(game:HttpGet("https://raw.githubusercontent.com/396abc/Script/refs/heads/main/MobileFly.lua"))()
    else
        loadstring(game:HttpGet("https://raw.githubusercontent.com/396abc/Script/refs/heads/main/FlyR15.lua"))()
    end
end)

-- 透视专区
local highlightPlayers = false
local highlights = {}
local nameTags = {}
espTab:Toggle("通用高亮", highlightPlayers, function(t)
    highlightPlayers = t
    local players = game:GetService("Players")
    
    if highlightPlayers then
        for _, plr in pairs(players:GetPlayers()) do
            if plr ~= LocalPlayer and plr.Character then
                local highlight = Instance.new("Highlight")
                highlight.Parent = plr.Character
                highlights[plr] = highlight

                local nameTag = Instance.new("BillboardGui")
                nameTag.Name = "PlayerNameTag"
                nameTag.Parent = plr.Character.Head
                nameTag.Size = UDim2.new(0, 200, 0, 50)
                nameTag.AlwaysOnTop = true

                local nameLabel = Instance.new("TextLabel")
                nameLabel.Parent = nameTag
                nameLabel.BackgroundTransparency = 1
                nameLabel.Size = UDim2.new(1, 0, 1, 0)
                nameLabel.Font = Enum.Font.SourceSansBold
                nameLabel.TextSize = 18
                nameLabel.TextColor3 = Color3.new(1,1,1)
                nameLabel.Text = plr.Name
                nameTags[plr] = nameTag
            end
        end
        
        players.PlayerAdded:Connect(function(plr)
            plr.CharacterAdded:Connect(function(char)
                if highlightPlayers then
                    local highlight = Instance.new("Highlight")
                    highlight.Parent = char
                    highlights[plr] = highlight

                    local nameTag = Instance.new("BillboardGui")
                    nameTag.Name = "PlayerNameTag"
                    nameTag.Parent = char.Head
                    nameTag.Size = UDim2.new(0, 200, 0, 50)
                    nameTag.AlwaysOnTop = true

                    local nameLabel = Instance.new("TextLabel")
                    nameLabel.Parent = nameTag
                    nameLabel.BackgroundTransparency = 1
                    nameLabel.Size = UDim2.new(1, 0, 1, 0)
                    nameLabel.Font = Enum.Font.SourceSansBold
                    nameLabel.TextSize = 18
                    nameLabel.TextColor3 = Color3.new(1,1,1)
                    nameLabel.Text = plr.Name
                    nameTags[plr] = nameTag
                end
            end)
        end)
    else
        for plr, highlight in pairs(highlights) do
            highlight:Destroy()
            highlights[plr] = nil
        end
        for plr, nameTag in pairs(nameTags) do
            nameTag:Destroy()
            nameTags[plr] = nil
        end
    end
end)

local function ApplyXray(obj)
    if obj:IsA("BasePart") and not xrayIgnored[obj] and obj.Parent ~= LocalPlayer.Character then
        xrayIgnored[obj] = {
            Transparency = obj.Transparency,
            Color = obj.Color
        }
        obj.Transparency = 0.7
        obj.Color = xrayColor
    end
end

local function RemoveXray(obj)
    if xrayIgnored[obj] then
        obj.Transparency = xrayIgnored[obj].Transparency
        obj.Color = xrayIgnored[obj].Color
        xrayIgnored[obj] = nil
    end
end

espTab:Toggle("启用Xray", xrayActive, function(t)
    xrayActive = t
    if xrayActive then
        for _,obj in pairs(Workspace:GetDescendants()) do
            ApplyXray(obj)
        end
        Workspace.DescendantAdded:Connect(ApplyXray)
    else
        for obj,_ in pairs(xrayIgnored) do
            RemoveXray(obj)
        end
    end
end)

-- 传送专区
tpTab:Button("保存当前位置", function()
    local character = LocalPlayer.Character
    local humanoidRootPart = character and character:FindFirstChild("HumanoidRootPart")
    if humanoidRootPart then
        savedPosition = humanoidRootPart.CFrame
    end
end)

tpTab:Button("传送至保存位置", function()
    local character = LocalPlayer.Character
    local humanoidRootPart = character and character:FindFirstChild("HumanoidRootPart")
    if humanoidRootPart and savedPosition then
        humanoidRootPart.CFrame = savedPosition
    end
end)

local saveIdText = "1"
tpTab:Textbox("位置编号(保存)", saveIdText, function(t)
    saveIdText = t and t or "1"
end)
tpTab:Button("编号保存位置", function()
    local character = LocalPlayer.Character
    local humanoidRootPart = character and character:FindFirstChild("HumanoidRootPart")
    if humanoidRootPart and saveIdText ~= "" then
        numberedPositions[saveIdText] = humanoidRootPart.CFrame
    end
end)

local tpIdText = "1"
tpTab:Textbox("位置编号(传送)", tpIdText, function(t)
    tpIdText = t and t or "1"
end)
tpTab:Button("传送至编号位置", function()
    local character = LocalPlayer.Character
    local humanoidRootPart = character and character:FindFirstChild("HumanoidRootPart")
    local targetCFrame = numberedPositions[tpIdText]
    if humanoidRootPart and targetCFrame then
        humanoidRootPart.CFrame = targetCFrame
    end
end)

local function getPlayerList()
    local list = {}
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            table.insert(list, plr.Name)
        end
    end
    return list
end
local playerDropdown = tpTab:Dropdown("选择玩家", getPlayerList(), function(t)
    selectedPlayer = Players:FindFirstChild(t)
end)

task.spawn(function()
    while task.wait(1) do
        local newList = getPlayerList()
        playerDropdown:Refresh(newList)
    end
end)

tpTab:Toggle("循环传送选中玩家", loopTpActive, function(t)
    loopTpActive = t
    if loopTpConn then
        loopTpConn:Disconnect()
        loopTpConn = nil
    end
    if loopTpActive then
        loopTpConn = RunService.Heartbeat:Connect(function()
            if selectedPlayer and selectedPlayer.Character then
                local targetRoot = selectedPlayer.Character:FindFirstChild("HumanoidRootPart")
                local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if targetRoot and myRoot then
                    myRoot.CFrame = targetRoot.CFrame * CFrame.new(0, 0, 3)
                end
            end
        end)
    end
end)

-- 甩飞专区核心功能
local function SkidFling(TargetPlayer)
    local Character = LocalPlayer.Character
    local Humanoid = Character and Character:FindFirstChildOfClass("Humanoid")
    local RootPart = Humanoid and Humanoid.RootPart
    local TCharacter = TargetPlayer.Character
    if not TCharacter then return end
    local THumanoid = TCharacter:FindFirstChildOfClass("Humanoid")
    local TRootPart = THumanoid and THumanoid.RootPart
    local THead = TCharacter:FindFirstChild("Head")
    local Accessory = TCharacter:FindFirstChildOfClass("Accessory")
    local Handle = Accessory and Accessory:FindFirstChild("Handle")

    if not (Character and Humanoid and RootPart) then return end
    if RootPart.Velocity.Magnitude < 50 then
        getgenv().OldPos = RootPart.CFrame
    end
    if THumanoid and THumanoid.Sit then return end

    if THead then
        Workspace.CurrentCamera.CameraSubject = THead
    elseif Handle then
        Workspace.CurrentCamera.CameraSubject = Handle
    elseif THumanoid and TRootPart then
        Workspace.CurrentCamera.CameraSubject = THumanoid
    end
    if not TCharacter:FindFirstChildWhichIsA("BasePart") then return end

    local FPos = function(BasePart, Pos, Ang)
        RootPart.CFrame = CFrame.new(BasePart.Position) * Pos * Ang
        Character:SetPrimaryPartCFrame(CFrame.new(BasePart.Position) * Pos * Ang)
        RootPart.Velocity = Vector3.new(9e7, 9e7 * 10, 9e7)
        RootPart.RotVelocity = Vector3.new(9e8, 9e8, 9e8)
    end

    local SFBasePart = function(BasePart)
        local TimeToWait = 2
        local Time = tick()
        local Angle = 0
        repeat
            if RootPart and THumanoid and flingActive then
                if BasePart.Velocity.Magnitude < 50 then
                    Angle = Angle + 100
                    FPos(BasePart, CFrame.new(0, 1.5, 0) + THumanoid.MoveDirection * BasePart.Velocity.Magnitude / 1.25, CFrame.Angles(math.rad(Angle),0 ,0))
                    task.wait()
                    FPos(BasePart, CFrame.new(0, -1.5, 0) + THumanoid.MoveDirection * BasePart.Velocity.Magnitude / 1.25, CFrame.Angles(math.rad(Angle), 0, 0))
                    task.wait()
                    FPos(BasePart, CFrame.new(0, 1.5, 0) + THumanoid.MoveDirection * BasePart.Velocity.Magnitude / 1.25, CFrame.Angles(math.rad(Angle),0 ,0))
                    task.wait()
                    FPos(BasePart, CFrame.new(0, -1.5, 0) + THumanoid.MoveDirection * BasePart.Velocity.Magnitude / 1.25, CFrame.Angles(math.rad(Angle), 0, 0))
                    task.wait()
                    FPos(BasePart, CFrame.new(0, 1.5, 0) + THumanoid.MoveDirection, CFrame.Angles(math.rad(Angle),0 ,0))
                    task.wait()
                    FPos(BasePart, CFrame.new(0, -1.5, 0) + THumanoid.MoveDirection, CFrame.Angles(math.rad(Angle), 0, 0))
                    task.wait()
                else
                    FPos(BasePart, CFrame.new(0, 1.5, THumanoid.WalkSpeed), CFrame.Angles(math.rad(90), 0, 0))
                    task.wait()
                    FPos(BasePart, CFrame.new(0, -1.5, -THumanoid.WalkSpeed), CFrame.Angles(0, 0, 0))
                    task.wait()
                    FPos(BasePart, CFrame.new(0, 1.5, THumanoid.WalkSpeed), CFrame.Angles(math.rad(90), 0, 0))
                    task.wait()
                    FPos(BasePart, CFrame.new(0, -1.5, 0), CFrame.Angles(math.rad(90), 0, 0))
                    task.wait()
                    FPos(BasePart, CFrame.new(0, -1.5, 0), CFrame.Angles(0, 0, 0))
                    task.wait()
                    FPos(BasePart, CFrame.new(0, -1.5, 0), CFrame.Angles(math.rad(90), 0, 0))
                    task.wait()
                    FPos(BasePart, CFrame.new(0, -1.5, 0), CFrame.Angles(0, 0, 0))
                    task.wait()
                end
            end
        until Time + TimeToWait < tick() or not flingActive
    end

    Workspace.FallenPartsDestroyHeight = 0/0
    local BV = Instance.new("BodyVelocity")
    BV.Parent = RootPart
    BV.Velocity = Vector3.new(0, 0, 0)
    BV.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    Humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated, false)

    if TRootPart then
        SFBasePart(TRootPart)
    elseif THead then
        SFBasePart(THead)
    elseif Handle then
        SFBasePart(Handle)
    else
        return
    end

    BV:Destroy()
    Humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated, true)
    Workspace.CurrentCamera.CameraSubject = Humanoid

    if getgenv().OldPos then
        repeat
            RootPart.CFrame = getgenv().OldPos * CFrame.new(0, .5, 0)
            Character:SetPrimaryPartCFrame(getgenv().OldPos * CFrame.new(0, .5, 0))
            Humanoid:ChangeState("GettingUp")
            for _, part in pairs(Character:GetChildren()) do
                if part:IsA("BasePart") then
                    part.Velocity, part.RotVelocity = Vector3.new(), Vector3.new()
                end
            end
            task.wait()
        until (RootPart.Position - getgenv().OldPos.p).Magnitude < 25
        Workspace.FallenPartsDestroyHeight = getgenv().FPDH
    end
end

-- 甩飞专区UI
local flingPlayerDropdown = flingTab:Dropdown("选择甩飞目标", getPlayerList(), function(t)
    flingSelectedPlayer = Players:FindFirstChild(t)
end)

-- 循环刷新玩家列表
task.spawn(function()
    while task.wait(1) do
        local newList = getPlayerList()
        flingPlayerDropdown:Refresh(newList)
    end
end)

-- 开始/停止甩飞Toggle
flingTab:Toggle("开始甩飞指定玩家", flingActive, function(t)
    flingActive = t
    if flingLoopConn then
        flingLoopConn:Disconnect()
        flingLoopConn = nil
    end
    if flingActive then
        if not flingSelectedPlayer then return end
        flingLoopConn = RunService.Heartbeat:Connect(function()
            if flingSelectedPlayer and flingSelectedPlayer.Character then
                SkidFling(flingSelectedPlayer)
                task.wait(0.5)
            end
        end)
    end
end)

-- 调整面板颜色
changeclr:Colorpicker("调整面板颜色", Color3.fromRGB(44, 120, 224), function(t)
    lib:ChangePresetColor(Color3.fromRGB(t.R*255, t.G*255, t.B*255))
end)
